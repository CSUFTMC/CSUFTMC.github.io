<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Status Widget</title>
    <style>
        :root {
            --bg-card: #ffffff;
            --bg-body: #f4f4f5;
            --text-main: #18181b;
            --text-sub: #71717a;
            --accent: #10b981;
            --offline: #ef4444;
            --border: #e4e4e7;
            --hover: #f4f4f5;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --chip-bg: #f4f4f5; /* ç©å®¶èƒ¶å›ŠèƒŒæ™¯ */
        }

        [data-theme="dark"] {
            --bg-card: #18181b;
            --bg-body: #09090b;
            --text-main: #f4f4f5;
            --text-sub: #a1a1aa;
            --border: #27272a;
            --hover: #27272a;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --chip-bg: #27272a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s;
        }

        .server-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 12px;
            width: 340px; /* ç¨å¾®åŠ å®½ä»¥å®¹çº³åå­— */
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .status-badge { display: flex; align-items: center; font-size: 14px; font-weight: 600; color: var(--text-main); }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; background-color: var(--offline); box-shadow: 0 0 0 2px var(--bg-card); }
        .dot.online { background-color: var(--accent); }

        .info { margin-bottom: 16px; }
        .motd { color: var(--text-main); font-size: 15px; margin-bottom: 4px; font-weight: 500; line-height: 1.4; }
        .sub-info { color: var(--text-sub); font-size: 12px; }

        /* ç©å®¶åˆ—è¡¨åŒºåŸŸ */
        .player-section {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            display: none;
        }
        
        .player-label {
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 10px;
            display: block;
            font-weight: 600;
        }

        .avatar-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* ç©å®¶èƒ¶å›Šæ ·å¼ (å¤´åƒ+åå­—) */
        .player-chip {
            display: flex;
            align-items: center;
            background-color: var(--chip-bg);
            padding: 4px 10px 4px 4px;
            border-radius: 20px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .player-chip:hover {
            border-color: var(--border);
            background-color: var(--bg-card);
        }

        .player-chip img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .player-chip span {
            font-size: 12px;
            color: var(--text-main);
            font-weight: 500;
        }

        /* åº•éƒ¨æ•°æ® */
        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-sub);
            margin-top: 16px;
        }
        .stat-item { display: flex; align-items: center; gap: 4px; }
        
        .theme-toggle {
            cursor: pointer;
            background: none; border: none; color: var(--text-sub); padding: 4px; border-radius: 4px; display: flex;
        }
        .theme-toggle:hover { background-color: var(--hover); color: var(--text-main); }
        .theme-toggle svg { width: 18px; height: 18px; }
    </style>
</head>
<body>

<div class="server-card" id="widget">
    <div class="header">
        <div class="status-badge">
            <span class="dot" id="statusDot"></span>
            <span id="hostText">Loading...</span>
        </div>
        <button class="theme-toggle" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
        </button>
    </div>

    <div class="info">
        <div class="motd" id="motd">æ­£åœ¨è·å–ä¿¡æ¯...</div>
        <div class="sub-info" id="version"></div>
    </div>

    <div class="player-section" id="playerSection">
        <span class="player-label" id="playerLabel">åœ¨çº¿ç©å®¶:</span>
        <div class="avatar-list" id="avatarList"></div>
    </div>

    <div class="stats">
        <div class="stat-item">
            <span>ğŸ‘¥</span>
            <span id="players">--/--</span>
        </div>
        <div class="stat-item">
            <span>ğŸ“¶</span>
            <span id="delay">-- ms</span>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://motd.minebbs.com/api/status?host=frp-oak.com:55907';
    
    const els = {
        card: document.getElementById('widget'),
        dot: document.getElementById('statusDot'),
        host: document.getElementById('hostText'),
        motd: document.getElementById('motd'),
        version: document.getElementById('version'),
        players: document.getElementById('players'),
        delay: document.getElementById('delay'),
        themeBtn: document.getElementById('themeBtn'),
        playerSection: document.getElementById('playerSection'),
        playerLabel: document.getElementById('playerLabel'),
        avatarList: document.getElementById('avatarList')
    };

    function initTheme() {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
    }

    els.themeBtn.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        if (newTheme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        else document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('theme', newTheme);
    });

    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            render(data);
        } catch (e) {
            els.motd.innerText = "è·å–çŠ¶æ€å¤±è´¥";
            els.dot.classList.remove('online');
        }
    }

    function render(data) {
        els.host.innerText = data.host || 'Server';
        
        if (data.status === 'online') {
            els.dot.classList.add('online');
            els.motd.innerText = data.pureMotd || 'No Description';
            els.version.innerText = data.version || '';
            
            if (data.players) {
                const onlineCount = data.players.online;
                els.players.innerText = `${onlineCount} / ${data.players.max}`;
                renderPlayers(data.players.sample, onlineCount);
            }
            els.delay.innerText = `${data.delay} ms`;
        } else {
            els.dot.classList.remove('online');
            els.motd.innerText = "æœåŠ¡å™¨ç¦»çº¿";
            els.playerSection.style.display = 'none';
        }
    }

    function renderPlayers(sampleString, totalOnline) {
        els.avatarList.innerHTML = '';
        
        // æ›´æ–°æ ‡ç­¾æ–‡æœ¬
        els.playerLabel.innerText = `åœ¨çº¿ç©å®¶ (${totalOnline}):`;

        if (!sampleString || typeof sampleString !== 'string') {
            els.playerSection.style.display = 'none';
            return;
        }

        const names = sampleString.split(',').map(s => s.trim()).filter(s => s.length > 0);

        if (names.length === 0) {
            els.playerSection.style.display = 'none';
            return;
        }

        els.playerSection.style.display = 'block';

        names.forEach(name => {
            // åˆ›å»ºèƒ¶å›Šå®¹å™¨
            const chip = document.createElement('div');
            chip.className = 'player-chip';
            
            // å¤´åƒ
            const img = document.createElement('img');
            img.src = `https://nmsr.nickac.dev/head/${name}`;
            img.alt = name;
            img.onerror = function() { this.src = 'data:image/svg+xml;base64,...'; }; // ç®€å•å¤„ç†ï¼šå¦‚æœå¤±è´¥å¯æ˜¾ç¤ºå ä½ç¬¦æˆ–éšè—
            
            // åå­—æ–‡æœ¬
            const span = document.createElement('span');
            span.innerText = name;

            chip.appendChild(img);
            chip.appendChild(span);
            els.avatarList.appendChild(chip);
        });
    }

    initTheme();
    fetchData();
</script>

</body>
</html>